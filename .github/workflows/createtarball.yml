name: Nightly source tarball (DDD)

on:
  workflow_run:
    workflows: ["Mirror DDD to GitHub"]
    types: [completed]
  workflow_dispatch:


permissions:
  contents: write

jobs:
  nightly:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      MIRROR_REPO: https://github.com/eickeler/ddd.git
    steps:

      - name: Checkout latest master

        run: |
          git clone --depth 1 --branch master "$MIRROR_REPO" ddd
          cd ddd
          echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_ENV


      - name: Build binaries

        working-directory: ddd
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential autoconf automake libtool make \
            libmotif-dev texinfo flex bison libtinyxml2-dev \
            libfreetype-dev libxft-dev libfontconfig-dev libncurses-dev \
            gawk gdb fonts-liberation fig2dev texlive 
          autoreconf -ifv
          ./configure
          make

      - name: Create source tarball

        working-directory: ddd
        run: |
          make dist
          # Rename/move to repo root with nightly name
          TARBALL=$(ls ddd-*.tar.gz | head -n1)
          mv "$TARBALL" "../ddd-nightly-${DATE}.tar.gz"


      - name: Publish nightly release (in this repo)

        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="nightly-${DATE}"
          gh release create "$TAG" --title "DDD Nightly $DATE" --prerelease --target "$COMMIT" || \
          gh release edit "$TAG" --title "DDD Nightly $DATE" --prerelease
          gh release upload "$TAG" "ddd-nightly-${DATE}.tar.gz" --clobber
