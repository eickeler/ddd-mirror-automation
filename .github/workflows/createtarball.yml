name: DDD Nightly source tarball

on:
  workflow_run:
    workflows: ["Mirror DDD to GitHub"]
    types: [completed]
  workflow_dispatch:


permissions:
  contents: write

jobs:
  nightly:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      MIRROR_REPO: https://github.com/eickeler/ddd.git
    steps:

      - name: Checkout latest master

        run: |
          git clone --depth 1 --branch master "$MIRROR_REPO" ddd
          cd ddd
          echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_ENV


      - name: Build binaries

        working-directory: ddd
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential autoconf automake libtool make libxpm-dev \
            libmotif-dev texinfo flex bison libtinyxml2-dev libxext-dev \
            libfreetype-dev libxft-dev libfontconfig-dev libncurses-dev \
            gawk gdb fonts-liberation fig2dev texlive 
          autoreconf -ifv
          ./configure
          make
          ddd/ddd --help

      - name: Create source tarball

        working-directory: ddd
        run: |
          make dist
          ls -l
          # Rename/move to repo root with nightly name
          TARBALL=$(ls ddd-*.tar.gz | head -n1)
          mv "$TARBALL" "../ddd-nightly-${DATE}.tar.gz"
          ls -l ..
          echo "$TARBALL"
          echo "${DATE}"


      - uses: actions/checkout@v4
      - name: Publish nightly release (in this repo)

        env:
          GH_TOKEN: ${{ github.token }}
          OWNER_REPO: ${{ github.repository }}  # e.g., eickeler/ddd-mirror-automation
        run: |
          TAG="nightly-${DATE}"
          # Create/edit release pointing to this repoâ€™s current commit (or omit --target)
          gh release create "$TAG" --repo "$OWNER_REPO" --title "DDD Nightly $DATE" --prerelease --target "$GITHUB_SHA" || \
          gh release edit "$TAG" --repo "$OWNER_REPO" --title "DDD Nightly $DATE" --prerelease
          gh release upload "$TAG" --repo "$OWNER_REPO" "ddd-nightly-${DATE}.tar.gz" --clobber
